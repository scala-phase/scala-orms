#                                                                 -*- ruby -*-
# Generate HTML slides, for S5, from Markdown input.
#
# See README.md for pre-requisites.
# ---------------------------------------------------------------------------

require 'rubygems'
require 'rake/clean'
require 'slidedown'
require 'albino'

SLIDE_SOURCE = 'sq.md'
SLIDE_HTML   = File.basename(SLIDE_SOURCE, ".md") + ".html"
SLIDE_INPUTS = [SLIDE_SOURCE]
SASS_DIR = "sass"
DATA_DIR = "data"
CSS_DIR = "."

SASS_FILES = FileList["#{SASS_DIR}/*.scss"]
CSS_OUTPUT_FILES = SASS_FILES.map do |f|
  f.gsub(/^#{SASS_DIR}/, CSS_DIR).gsub(/\.scss$/, '.stylesheets')
end

CLEAN << CSS_OUTPUT_FILES
CLEAN << FileList['*.html']

task :default => :slides
task :slides => SLIDE_HTML
task :css => CSS_OUTPUT_FILES

task :init do
  if pygmentize = find_pygmentize
    Albino.bin = pygmentize
  else
    raise StandardError.new "Can't find pygmentize in path."
  end
end

file SLIDE_HTML => [:init, 'Rakefile'] + CSS_OUTPUT_FILES + SLIDE_INPUTS do |t|
  require 'tempfile'
  temp = Tempfile.new('slide')
  begin
    puts "slidedown #{SLIDE_SOURCE}"
    _stdout = $stdout
    $stdout = temp
    begin
      SlideDown.run! [SLIDE_SOURCE]
    ensure
      $stdout = _stdout
    end

    # Edit the resulting source: SlideDown uses the full path to the local
    # stylesheets, which isn't portable.

    dir = File.dirname(__FILE__) + "/"
    temp.rewind
    edited_lines = temp.readlines.map do |line|
      line.gsub(%r|#{dir}|, "")
    end
    File.open(SLIDE_HTML, 'w').write(edited_lines.join(''))
  ensure
    temp.close
    temp.unlink
  end
end

# ---------------------------------------------------------------------------
# Auto-generate CSS files from any SASS input files.

def find_pygmentize
  loc = nil
  ENV["PATH"].split(":").each do |p|
    p = File.join(p, "pygmentize")
    if File.exist?(p) and File.executable?(p)
      loc = p
      break
    end
  end
  return loc
end

directory CSS_DIR

# Figure out the name of the SCSS file necessary make a CSS file.
def css_to_scss
  Proc.new {|task| task.sub(/^#{CSS_DIR}/, SASS_DIR).
                        sub(/\.stylesheets$/, '.scss')}
end

rule %r{^#{CSS_DIR}/.*\.stylesheets$} => [css_to_scss, 'Rakefile'] + SASS_FILES do |t|
  require 'sass'
  mkdir_p CSS_DIR
  puts("#{t.source} -> #{t.name}")
  Dir.chdir('sass') do
    sass_input = File.basename(t.source)
    engine = Sass::Engine.new(File.open(sass_input).readlines.join(''),
                              :syntax => :scss)
    out = File.open(File.join('..', t.name), 'w')
    out.write("/* AUTOMATICALLY GENERATED FROM #{t.source} on #{Time.now} */\n")
    out.write(engine.render)
    # Force close, to force flush BEFORE running other tasks.
    out.close
  end
end


